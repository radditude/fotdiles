#!/usr/bin/env bash -e

source $DOTFILES/functions/log

usage () {
		echo ""
		success "Dark mode for the MacOS desktop Slack client"
		info "USAGE:"
		info "  $(basename $0)"
		info "    - enable dark mode or apply updated CSS overrides"
		info "  $(basename $0) undo"
		info "    - revert to light mode"
		info "  $(basename $0) [help|usage]"
		info "    - this message"
		echo ""
		exit 
}

FLAG="slackdarkmodehack"

DIR="/Applications/Slack.app/Contents/Resources"
FILE="$DIR/app.asar.darkmode/dist/ssb-interop.bundle.js"

CSS_OVERRIDES='code, pre, .CodeMirror { background-color: #535353; color: #85c5ff; }'

SLACKDARKMODE="
	document.addEventListener('DOMContentLoaded', function darkMode() {
		$.ajax({
			url:
				'https://cdn.jsdelivr.net/gh/laCour/slack-night-mode/css/raw/black.css',
			success: function success(css) {
				let overrides = \`$CSS_OVERRIDES\`;
				\$('<style></style>').appendTo('head').html(css + overrides);
			},
		});
	}); //$FLAG"

append_snippet () {
	echo "$SLACKDARKMODE" | tr '\n' ' ' | tr -s '[:blank:]' | sudo tee -a $FILE > /dev/null
}

undo () {
	sudo sed -i "" "/$FLAG/d" $FILE
}

restart_slack () {
	info "restarting Slack..."
  killall Slack &> /dev/null
	open /Applications/Slack.app
}

unpack_archive () {
	npm install -g asar
	sudo asar extract $DIR/app.asar $DIR/app.asar.darkmode
}

repack_archive () {
	sudo asar pack $DIR/app.asar.darkmode $DIR/app.asar
}

fixslack () {
	if [[ "$1" == "undo" ]]
	then
		user_prompt "disabling dark mode... you may need to enter your password."
		unpack_archive
		undo
		repack_archive
		restart_slack
		success "slack dark mode disabled!"
		exit
	elif [[ "$1" == "usage" || "$1" == "help" ]]
	then
		usage
	fi

  user_prompt "enabling dark mode... you may need to enter your password."
	unpack_archive

  if grep -q "//$FLAG" $FILE
	then
		undo
	fi

	append_snippet
	repack_archive
  restart_slack
  success "your slack has been endarkened!"
}

fixslack "$@"
